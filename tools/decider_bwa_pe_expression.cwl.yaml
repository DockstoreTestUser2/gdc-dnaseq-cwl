#!/usr/bin/env cwl-runner

cwlVersion: v1.0

requirements:
  - class: InlineJavascriptRequirement

class: ExpressionTool

inputs:
  - id: fastq1_path
    format: "edam:format_2182"
    type:
      type: array
      items: File

  - id: fastq2_path
    format: "edam:format_2182"
    type:
      type: array
      items: File

  - id: readgroup_path
    format: "edam:format_3464"
    type:
      type: array
      items: File

outputs:
  - id: output_fastq1_paths
    format: "edam:format_2182"
    type:
      type: array
      items: File

  - id: output_fastq2_paths
    format: "edam:format_2182"
    type:
      type: array
      items: File

  - id: output_readgroup_paths
    format: "edam:format_3464"
    type:
      type: array
      items: File

expression: |
   ${
      function local_basename(path) {
        var basename = path.split(/[\\/]/).pop();
        return basename
      }

      function local_dirname(path) {
        return path.replace(/\\/g,'/').replace(/\/[^\/]*$/, '');
      }

      var readgroup_path_array = [];
      for (var fq1_path in inputs.fastq1_path.location) {
        var fq_name = local_basename(fq1_path);
        var readgroup_name = fq_name.slice(0,-8) + ".json";
        var readgroup_dir = local_dirname(inputs.readgroup_path.location[0]);
        var readgroup_path = readgroup_dir + "/" + readgroup_name;
        readgroup_path_array.push(readgroup_path);
      }
      var readgroup_obj_array = [];
      for (var readgroup_path in readgroup_path_array) {
        for (var readgroup_obj in inputs.readgroup_path) {
          if (readgroup_path == readgroup_obj.location) {
            readgroup_obj_array.push(readgroup_obj);
          }
        }
      }

      return [
        {'output_fastq1_paths': inputs.fastq1_path},
        {'output_fastq2_paths': inputs.fastq2_path},
        {'output_readgroup_paths': inputs.readgroup_obj_array},
      ]
    }
