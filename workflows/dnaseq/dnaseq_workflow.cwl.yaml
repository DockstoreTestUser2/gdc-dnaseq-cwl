#!/usr/bin/env cwl-runner

class: Workflow

requirements:
  - class: ScatterFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement
  - $import: ../../tools/envvar-global.cwl

inputs:
  - id: "#bam_path"
    type: File
  - id: "#reference_fasta_path"
    type: File
  - id: "#thread_count"
    type: int
  - id: "#uuid"
    type: string
  - id: "#db_cred_s3url"
    type: ["null", string]
  - id: "#s3cfg_path"
    type: ["null", File]
outputs:
  - id: "#picard_markduplicates_output_bam"
    type: File
    source: "#picard_markduplicates.output_bam"
  - id: "#merge_all_sqlite_destination_sqlite"
    type: File
    source: "#merge_all_sqlite.destination_sqlite"
steps:
  - id: "#bam_readgroup_to_json"
    run: {import: ../../tools/bam_readgroup_to_json.cwl.yaml}
    inputs:
      - id: "#bam_readgroup_to_json.bam_path"
        source: "#bam_path"
      - id: "#bam_readgroup_to_json.uuid"
        source: "#uuid"
    outputs:
      - id: "#bam_readgroup_to_json.output_json"
  
  - id: "#biobambam2_bamtofastq"
    run: {import: ../../tools/biobambam2_bamtofastq.cwl.yaml}
    inputs:
      - id: "#biobambam2_bamtofastq.bam_path"
        source: "#bam_path"
      - id: "#biobambam2_bamtofastq.uuid"
        source: "#uuid"
      - id: "#biobambam2_bamtofastq.input_state"
        default: "original"
    outputs:
      - id: "#biobambam2_bamtofastq.output_fastq1"
      - id: "#biobambam2_bamtofastq.output_fastq2"
      - id: "#biobambam2_bamtofastq.log"
      - id: "#biobambam2_bamtofastq.output_sqlite"
  
  - id: "#bwa_pe"
    run: { import: ../../tools/bwa_pe.cwl.yaml }
    scatter: ["#bwa_pe.fastq1_path", "#bwa_pe.fastq2_path", "#bwa_pe.readgroup_json_path"]
    scatterMethod: "dotproduct"
    inputs:
      - id: "#bwa_pe.fastq1_path"
        source: "#biobambam2_bamtofastq.output_fastq1"
      - id: "#bwa_pe.fastq2_path"
        source: "#biobambam2_bamtofastq.output_fastq2"
      - id: "#bwa_pe.reference_fasta_path"
        source: "#reference_fasta_path"
      - id: "#bwa_pe.readgroup_json_path"
        source: "#bam_readgroup_to_json.output_json"
      - id: "#bwa_pe.thread_count"
        source: "#thread_count"
      - id: "#bwa_pe.uuid"
        source: "#uuid"
    outputs:
      - id: "#bwa_pe.output_bam"
      - id: "#bwa_pe.output_sqlite"
      - id: "#bwa_pe.log"

  - id: "#merge_bwa_pe_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_bwa_pe_sqlite.source_sqlite"
        source: "#bwa_pe.output_sqlite"
      - id: "#merge_bwa_pe_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_bwa_pe_sqlite.destination_sqlite"
        
  - id: "#picard_sortsam"
    run: {import: ../../tools/picard_sortsam.cwl.yaml}
    scatter: "#picard_sortsam.bam_path"
    inputs:
      - id: "#picard_sortsam.bam_path"
        source: "#bwa_pe.output_bam"
      - id: "#picard_sortsam.uuid"
        source: "#uuid"
      - id: "#picard_sortsam.input_state"
        default: "aligned_readgroup"
    outputs:
      - id: "#picard_sortsam.output_bam"
      - id: "#picard_sortsam.log"
      - id: "#picard_sortsam.output_sqlite"

  - id: "#merge_picard_sortsam_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_picard_sortsam_sqlite.source_sqlite"
        source: "#picard_sortsam.output_sqlite"
      - id: "#merge_picard_sortsam_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_picard_sortsam_sqlite.destination_sqlite"
          
  - id: "#picard_buildbamindex"
    run: {import: ../../tools/picard_buildbamindex.cwl.yaml}
    scatter: "#picard_buildbamindex.bam_path"
    inputs:
      - id: "#picard_buildbamindex.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#picard_buildbamindex.uuid"
        source: "#uuid"
      - id: "#picard_buildbamindex.input_state"
        default: "sorted_readgroup"
    outputs:
      - id: "#picard_buildbamindex.output_bai"
      - id: "#picard_buildbamindex.output_sqlite"
      - id: "#picard_buildbamindex.log"

  - id: "#merge_picard_buildbamindex_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_picard_buildbamindex_sqlite.source_sqlite"
        source: "#picard_buildbamindex.output_sqlite"
      - id: "#merge_picard_buildbamindex_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_picard_buildbamindex_sqlite.destination_sqlite"

  - id: "#picard_mergesamfiles"
    run: {import: ../../tools/picard_mergesamfiles.cwl.yaml}
    inputs:
      - id: "#picard_mergesamfiles.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#picard_mergesamfiles.uuid"
        source: "#uuid"
      - id: "#picard_mergesamfiles.outbam_name"
        source: "#bam_path"
        valueFrom: $(self.path.split('/').slice(-1)[0])
      - id: "#picard_mergesamfiles.input_state"
        default: "sorted_readgroup"
    outputs:
      - id: "#picard_mergesamfiles.output_bam"
      - id: "#picard_mergesamfiles.log"

  - id: "#bam_reheader"
    run: {import: ../../tools/bam_reheader.cwl.yaml}
    inputs:
      - id: "#bam_reheader.bam_path"
        source: "#picard_mergesamfiles.output_bam"
      - id: "#bam_reheader.uuid"
        source: "#uuid"
      - id: "#bam_reheader.input_state"
        default: "merged_readgroups"
    outputs:
      - id: "#bam_reheader.output_bam"
      - id: "#bam_reheader.log"

  - id: "#picard_markduplicates"
    run: {import: ../../tools/picard_markduplicates.cwl.yaml}
    inputs:
      - id: "#picard_markduplicates.bam_path"
        source: "#bam_reheader.output_bam"
      - id: "##picard_markduplicates.uuid"
        source: "#uuid"
      - id: "#picard_markduplicates.input_state"
        default: "reheadered_readgroups"
    outputs:
      - id: "#picard_markduplicates.output_bam"
      - id: "#picard_markduplicates.output_bai"
      - id: "#picard_markduplicates.log"

  - id: "#fastqc1"
    run: {import: ../../tools/fastqc.cwl.yaml}
    scatter: "#fastqc1.fastq_path"
    inputs:
      - id: "#fastqc1.fastq_path"
        source: "#biobambam2_bamtofastq.output_fastq1"
      - id: "#fastqc1.uuid"
        source: "#uuid"
      - id: "#fastqc1.thread_count"
        source: "#thread_count"
    outputs:
      - id: "#fastqc1.fastqc_zip"
      - id: "#fastqc1.log"
      - id: "#fastqc1.output_sqlite"

  - id: "#merge_fastqc1_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_fastqc1_sqlite.source_sqlite"
        source: "#fastqc1.output_sqlite"
      - id: "#merge_fastqc1_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_fastqc1_sqlite.destination_sqlite"

  - id: "#fastqc_db1"
    run: {import: ../../tools/fastqc_db.cwl.yaml}
    scatter: "#fastqc_db1.fastqc_zip_path"
    inputs:
      - id: "#fastqc_db1.fastqc_zip_path"
        source: "#fastqc1.fastqc_zip"
      - id: "#fastqc_db1.uuid"
        source: "#uuid"
    outputs:
      - id: "#fastqc_db1.output_sqlite"
      - id: "#fastqc_db1.log"

  - id: "#merge_fastqc_db1_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_fastqc_db1_sqlite.source_sqlite"
        source: "#fastqc_db1.output_sqlite"
      - id: "#merge_fastqc_db1_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_fastqc_db1_sqlite.destination_sqlite"

  - id: "#fastqc2"
    run: {import: ../../tools/fastqc.cwl.yaml}
    scatter: "#fastqc2.fastq_path"
    inputs:
      - id: "#fastqc2.fastq_path"
        source: "#biobambam2_bamtofastq.output_fastq2"
      - id: "#fastqc2.uuid"
        source: "#uuid"
      - id: "#fastqc2.thread_count"
        source: "#thread_count"
    outputs:
      - id: "#fastqc2.fastqc_zip"
      - id: "#fastqc2.log"
      - id: "#fastqc2.output_sqlite"

  - id: "#merge_fastqc2_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_fastqc2_sqlite.source_sqlite"
        source: "#fastqc2.output_sqlite"
      - id: "#merge_fastqc2_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_fastqc2_sqlite.destination_sqlite"

  - id: "#fastqc_db2"
    run: {import: ../../tools/fastqc_db.cwl.yaml}
    scatter: "#fastqc_db2.fastqc_zip_path"
    inputs:
      - id: "#fastqc_db2.fastqc_zip_path"
        source: "#fastqc2.fastqc_zip"
      - id: "#fastqc_db2.uuid"
        source: "#uuid"
    outputs:
      - id: "#fastqc_db2.output_sqlite"
      - id: "#fastqc_db2.log"

  - id: "#merge_fastqc_db2_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_fastqc_db2_sqlite.source_sqlite"
        source: "#fastqc_db2.output_sqlite"
      - id: "#merge_fastqc_db2_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_fastqc_db2_sqlite.destination_sqlite"

  - id: "#picard_validatesamfile_original" #need eof and dup QNAME detection
    run: {import: ../../tools/picard_validatesamfile.cwl.yaml}
    inputs:
      - id: "#picard_validatesamfile.bam_path"
        source: "#bam_path"
      - id: "#picard_validatesamfile.uuid"
        source: "#uuid"
      - id: "#picard_validatesamfile.input_state"
        default: "original"
    outputs:
      - id: "#picard_validatesamfile.sqlite"
      - id: "#picard_validatesamfile.log"

  - id: "#picard_validatesamfile_markduplicates" #need eof and dup QNAME detection
    run: {import: ../../tools/picard_validatesamfile.cwl.yaml}
    inputs:
      - id: "#picard_validatesamfile.bam_path"
        source: "#picard_markduplicates.output_bam"
      - id: "#picard_validatesamfile.uuid"
        source: "#uuid"
      - id: "#picard_validatesamfile.input_state"
        default: "markduplicates_readgroups"
    outputs:
      - id: "#picard_validatesamfile.sqlite"
      - id: "#picard_validatesamfile.log"
        
  - id: "#picard_collectalignmentsummarymetrics_original"
    run: {import: ../../tools/picard_collectalignmentsummarymetrics.cwl.yaml}
    inputs:
      - id: "#picard_collectalignmentsummarymetrics_original.bam_path"
        source: "#bam_path"
      - id: "#picard_collectalignmentsummarymetrics_original.reference_fasta_path"
        source: "#reference_fasta_path"
      - id: "#picard_collectalignmentsummarymetrics_original.uuid"
        source: "#uuid"
      - id: "#picard_collectalignmentsummarymetrics_original.input_state"
        default: "original"
    outputs:
      - id: "#picard_collectalignmentsummarymetrics_pre.output_sqlite"

  - id: "#picard_collectalignmentsummarymetrics_markduplicates"
    run: {import: ../../tools/picard_collectalignmentsummarymetrics.cwl.yaml}
    inputs:
      - id: "#picard_collectalignmentsummarymetrics_markduplicates.bam_path"
        source: "#picard_markduplicates.output_bam"
      - id: "#picard_collectalignmentsummarymetrics_markduplicates.reference_fasta_path"
        source: "#reference_fasta_path"
      - id: "#picard_collectalignmentsummarymetrics_markduplicates.uuid"
        source: "#uuid"
      - id: "#picard_collectalignmentsummarymetrics_markduplicates.input_state"
        default: "markduplicates_readgroups"
    outputs:
      - id: "#picard_collectalignmentsummarymetrics_post.output_sqlite"

  - id: "#readgroup_json_db"
    run: {import: ../../tools/readgroup_json_db.cwl.yaml}
    scatter: "#readgroup_json_db.json_path"
    inputs:
      - id: "#readgroup_json_db.json_path"
        source: "#bam_readgroup_to_json.output_json"
      - id: "#readgroup_json_db.uuid"
        source: "#uuid"
    outputs:
      - id: "#readgroup_json_db.output_sqlite"
      - id: "#readgroup_json_db.log"

  - id: "#merge_readgroup_json_db_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_readgroup_json_db_sqlite.source_sqlite"
        source: "#readgroup_json_db.output_sqlite"
      - id: "#merge_readgroup_json_db_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_readgroup_json_db_sqlite.destination_sqlite"

  # # - id: "#samtools_idxstats"
  # #   run: {import: ../../tools/samtools_idxstats.cwl.yaml}
  # #   scatter: "#samtools_idxstats.bam_path"
  # #   inputs:
  # #     - id: "#samtools_idxstats.bam_path"
  # #       source: "#picard_buildbamindex.output_bam"
  # #     - id: "#samtools_idxstats.uuid"
  # #       source: "#uuid"
  # #     - id: "#samtools_idxstats.input_state"
  # #       default: "sorted_readgroup"
  # #   outputs:
  # #     - id: "#samtools_idxstats.output_sqlite"
  # #     - id: "#samtools_idxstats.log"

  # # - id: "#merge_samtools_idxstats_sqlite"
  # #   run: {import: ../../tools/merge_sqlite.cwl.yaml}
  # #   inputs:
  # #     - id: "#merge_samtools_idxstats_sqlite.source_sqlite"
  # #       source: "#samtools_idxstats.output_sqlite"
  # #     - id: "#merge_samtools_idxstats_sqlite.uuid"
  # #       source: "#uuid"
  # #   outputs:
  # #     - id: "#merge_samtools_idxstats_sqlite.destination_sqlite"


  - id: "#samtools_flagstat"
    run: {import: ../../tools/samtools_flagstat.cwl.yaml}
    scatter: "#samtools_flagstat.bam_path"
    inputs:
      - id: "#samtools_flagstat.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#samtools_flagstat.uuid"
        source: "#uuid"
      - id: "#samtools_flagstat.input_state"
        default: "sorted_readgroup"
    outputs:
      - id: "#samtools_flagstat.output_sqlite"
      - id: "#samtools_flagstat.log"

  - id: "#merge_samtools_flagstat_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_samtools_flagstat_sqlite.source_sqlite"
        source: "#samtools_flagstat.output_sqlite"
      - id: "#merge_samtools_flagstat_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_samtools_flagstat_sqlite.destination_sqlite"

  - id: "#samtools_stats"
    run: {import: ../../tools/samtools_stats.cwl.yaml}
    scatter: "#samtools_stats.bam_path"
    inputs:
      - id: "#samtools_stats.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#samtools_stats.uuid"
        source: "#uuid"
      - id: "#samtools_stats.input_state"
        default: "sorted_readgroup"
    outputs:
      - id: "#samtools_stats.output_sqlite"
      - id: "#samtools_stats.log"

  - id: "#merge_samtools_stats_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_samtools_stats_sqlite.source_sqlite"
        source: "#samtools_stats.output_sqlite"
      - id: "#merge_samtools_stats_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_samtools_stats_sqlite.destination_sqlite"

  - id: "#picard_collectmultiplemetrics"
    run: {import: ../../tools/picard_collectmultiplemetrics.cwl.yaml}
    scatter: "#picard_collectmultiplemetrics.bam_path"
    inputs:
      - id: "#picard_collectmultiplemetrics.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#picard_collectmultiplemetrics.uuid"
        source: "#uuid"
      - id: "#picard_collectmultiplemetrics.reference_fasta_path"
        source: "#reference_fasta_path"
      - id: "#picard_collectmultiplemetrics.input_state"
        default: "sorted_readgroup"
    outputs:
      - id: "#picard_collectmultiplemetrics.output_sqlite"
      - id: "#picard_collectmultiplemetrics.log"

  - id: "#merge_picard_collectmultiplemetrics_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_picard_collectmultiplemetrics_sqlite.source_sqlite"
        source: "#picard_collectmultiplemetrics.output_sqlite"
      - id: "#merge_picard_collectmultiplemetrics_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_picard_collectmultiplemetrics_sqlite.destination_sqlite"

  - id: "#merge_all_sqlite"
    run: {import: ../../tools/merge_sqlite.cwl.yaml}
    inputs:
      - id: "#merge_all_sqlite.source_sqlite"
        source: [ "#merge_bwa_pe_sqlite.destination_sqlite", "#merge_picard_sortsam_sqlite.destination_sqlite", "#merge_picard_buildbamindex_sqlite.destination_sqlite", "#merge_fastqc1_sqlite.destination_sqlite", "#merge_fastqc_db1_sqlite.destination_sqlite", "#merge_fastqc2_sqlite.destination_sqlite", "#merge_fastqc_db2_sqlite.destination_sqlite", "#merge_readgroup_json_db_sqlite.destination_sqlite", "#merge_samtools_flagstat_sqlite.destination_sqlite", "#merge_samtools_stats_sqlite.destination_sqlite", "#merge_picard_collectmultiplemetrics_sqlite.destination_sqlite"]
      - id: "#merge_all_sqlite.uuid"
        source: "#uuid"
    outputs:
      - id: "#merge_all_sqlite.destination_sqlite"
