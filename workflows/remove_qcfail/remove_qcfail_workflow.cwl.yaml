#!/usr/bin/env cwl-runner

class: Workflow

inputs:
  - id: "#first_input_bam"
    type: File
  - id: "#second_input_bam"
    type: File
  - id: "#second_bam_reference"
    type: File    
  - id: "#uuid"
    type: string

outputs:
  - id: "#picard_markduplicates_sqlite"
    type: File
    source: "#picard_markduplicates.output_sqlite"

  - id: "#picard_markduplicates_output_bam"
    type: File
    source: "#picard_markduplicates.output_bam"


steps:
  - id: "#remove_qcfail"
    run: {import: ../../tools/remove_qcfail.cwl.yaml}
    inputs:
      - id: "#remove_qcfail.first_input_bam"
        source: "#first_input_bam"

      - id: "#remove_qcfail.second_input_bam"
        source: "#second_input_bam"

      - id: "#remove_qcfail.uuid"
        source: "#uuid"

    outputs:
      - id: "#remove_qcfail.output_bam"
      - id: "#remove_qcfail.output_sqlite"
      - id: "#remove_qcfail.log"


  - id: "#picard_markduplicates"
    requirements:
      - class: CreateFileRequirement
        fileDef:
          - filename:
              engine: "../../tools/node-engine.cwl"
              script: |
                {
                return $job['uuid']+".db"
                }
            fileContent:
              engine:  "cwl:JsonPointer"
              script: "job/remove_qcfail.output_sqlite"
  
    run: {import: ../../tools/picard_markduplicates.cwl.yaml}
    inputs:
      - id: "#picard_markduplicates.input_bam"
        source: "#remove_qcfail.output_bam"

      - id: "#picard_markduplicates.uuid"
        source: "#uuid"

      - id: "#picard_markduplicates.input_sqlite"
        source: "#remove_qcfail.output_sqlite"

    outputs:
      - id: "#picard_markduplicates.output_bam"

      - id: "#picard_markduplicates.output_sqlite"