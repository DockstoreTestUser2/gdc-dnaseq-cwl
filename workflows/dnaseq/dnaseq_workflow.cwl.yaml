#!/usr/bin/env cwl-runner

class: Workflow
requirements:
  - class: ScatterFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement


inputs:
  - id: "#fastq1_path" # temp for testing
    type: File
  - id: "#fastq2_path" # temp for testing
    type: File
  - id: "#readgroup_json_path" # temp for testing
    type: File
  - id: "#input_bam" # temp for testing
    type:
      type: array
      items: File
  - id: "#bam_path"
    type: File
  - id: "#reference_fasta_path"
    type: File
  - id: "#thread_count"
    type: string
  - id: "#uuid"
    type: string
  - id: "#db_cred_s3url"
    type: ["null", string]
  - id: "#s3cfg_path"
    type: ["null", File]

outputs:
  - id: "#picard_sortsam_output_bam"
    type:
      type: array
      items: File
    source: "#picard_sortsam.output_bam"
  - id: "#bam_readgroup_to_json_output_json"
    type:
      type: array
      items: File
    source: "#bam_readgroup_to_json.output_json"
  - id: "#picard_mergesamfiles_output_bam"
    type: File
    source: "#picard_mergesamfiles.output_bam"


steps:
  - id: "#bam_readgroup_to_json"
    run: {import: ../../tools/bam_readgroup_to_json.cwl.yaml}
    inputs:
      - id: "#bam_readgroup_to_json.bam_path"
        source: "#bam_path"
      - id: "#bam_readgroup_to_json.uuid"
        source: "#uuid"
    outputs:
      - id: "#bam_readgroup_to_json.output_json"

  - id: "#picard_sortsam"
    run: { import: ../../tools/picard_sortsam.cwl.yaml }
    scatter: "#picard_sortsam.bam_path"
    inputs:
      - id: "#picard_sortsam.bam_path"
        source: "#input_bam"
      - id: "#picard_sortsam.uuid"
        source: "#uuid"
    outputs:
      - id: "#picard_sortsam.output_bam"
      - id: "#picard_sortsam.log"

          
  - id: "#picard_mergesamfiles"
    run: {import: ../../tools/picard_mergesamfiles.cwl.yaml}
    inputs:
      - id: "#picard_mergesamfiles.bam_path"
        source: "#picard_sortsam.output_bam"
      - id: "#picard_mergesamfiles.uuid"
        source: "#uuid"
      - id: "#picard_mergesamfiles.outbam_name"
        source: "#bam_path"
        valueFrom: $(self.path.split('/').slice(-1)[0])
    outputs:
      - id: "#picard_mergesamfiles.output_bam"
      - id: "#picard_mergesamfiles.log"
