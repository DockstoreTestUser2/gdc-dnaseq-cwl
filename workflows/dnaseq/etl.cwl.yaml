#!/usr/bin/env cwl-runner

cwlVersion: "cwl:draft-3"

class: Workflow

requirements:
  - class: InlineJavascriptRequirement
  - class: StepInputExpressionRequirement

inputs:
  - id: bam_s3url
    type: string
  - id: db_snp_s3url
    type: string
  - id: reference_fasta_s3url
    type: string
  - id: db_cred_s3url
    type: string
  - id: thread_count
    type: int
  - id: uuid
    type: string
  - id: aws_config_file
    type: File
  - id: aws_shared_credentials_file
    type: File
  - id: extract_s3cfg_section
    type: string
  - id: extract_endpoint_url
    type: string
  - id: load_s3cfg_section
    type: string
  - id: load_endpoint_url
    type: string

outputs:
  - id: extract_bam_output
    type: File
    source: "#extract_bam/output"
  - id: extract_db_snp_output
    type: File
    source: "#extract_db_snp/output"
  - id: extract_fasta_fa_output
    type: File
    source: "#extract_fasta_fa/output"
  - id: extract_fasta_amb_output
    type: File
    source: "#extract_fasta_amb/output"
  - id: extract_fasta_ann_output
    type: File
    source: "#extract_fasta_ann/output"
  - id: extract_fasta_bwt_output
    type: File
    source: "#extract_fasta_bwt/output"
  - id: extract_fasta_fai_output
    type: File
    source: "#extract_fasta_fai/output"
  - id: extract_fasta_pac_output
    type: File
    source: "#extract_fasta_pac/output"
  - id: extract_fasta_sa_output
    type: File
    source: "#extract_fasta_sa/output"

steps:
  - id: extract_bam
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#bam_s3url"
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_db_snp
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#db_snp_s3url"
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_fa
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_amb
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".amb")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_ann
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".ann")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_bwt
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".bwt")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_fai
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".fai")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_pac
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".pac")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  - id: extract_fasta_sa
    run: ../../tools/aws_s3_get.cwl.yaml
    inputs:
      - id: aws_config_file
        source: "#aws_config_file"
      - id: aws_shared_credentials_file
        source: "#aws_shared_credentials_file"
      - id: s3uri
        source: "#reference_fasta_s3url"
        valueFrom: $(self + ".sa")
      - id: s3cfg_section
        source: "#extract_s3cfg_section"
      - id: endpoint_url
        source: "#extract_endpoint_url"
    outputs:
      - id: output
      - id: bin_time

  # - id: root_fasta_files
        
  # - id: bam_readgroup_to_json
  #   run: ../../tools/bam_readgroup_to_json.cwl.yaml
  #   inputs:
  #     - id: bam_path
  #       source: "#bam_path"
  #     - id: uuid
  #       source: "#uuid"
  #   outputs:
  #     - id: output_json
