#!/usr/bin/env cwl-runner

cwlVersion: "cwl:draft-3"

class: Workflow

requirements:
  - class: InlineJavascriptRequirement
  - class: MultipleInputFeatureRequirement
  - class: ScatterFeatureRequirement
  - class: StepInputExpressionRequirement

inputs:
  - id: bam_path
    type: File
  - id: db_snp_path
    type: File
  - id: reference_fasta_path
    type: File
  - id: thread_count
    type: int
  - id: uuid
    type: string
  - id: input_state
    type: string

outputs:
  - id: picard_markduplicates_output_bam
    type: File
    source: "#picard_markduplicates/output_bam"
  - id: merge_all_sqlite_destination_sqlite
    type: File
    source: "#merge_all_sqlite/destination_sqlite"

steps:
  - id: picard_buildbamindex
    run: ../../tools/picard_buildbamindex.cwl.yaml
    scatter: "#picard_buildbamindex/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_sortsam/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "sorted_readgroup"
    outputs:
      - id: output_bam
      - id: output_sqlite
      - id: log

  - id: picard_markduplicates
    run: ../../tools/picard_markduplicates.cwl.yaml
    inputs:
      - id: bam_path
        source: "#bam_reheader/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        source: "#input_state"
    outputs:
      - id: output_bam
      - id: log

  - id: picard_validatesamfile_original #need eof and dup QNAME detection
    run: ../../tools/picard_validatesamfile.cwl.yaml
    inputs:
      - id: bam_path
        source: "#bam_path"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "original"
    outputs:
      - id: output_sqlite
      - id: log

  - id: picard_validatesamfile_markduplicates #need eof and dup QNAME detection
    run: ../../tools/picard_validatesamfile.cwl.yaml
    inputs:
      - id: bam_path
        source: "#picard_markduplicates/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "markduplicates_readgroups"
    outputs:
      - id: output_sqlite
      - id: log

  - id: picard_collectalignmentsummarymetrics_original
    run: ../../tools/picard_collectalignmentsummarymetrics.cwl.yaml
    inputs:
      - id: bam_path
        source: "#bam_path"
      - id: reference_fasta_path
        source: "#reference_fasta_path"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "original"
    outputs:
      - id: output_sqlite

  - id: picard_collectalignmentsummarymetrics_markduplicates
    run: ../../tools/picard_collectalignmentsummarymetrics.cwl.yaml
    inputs:
      - id: bam_path
        source: "#picard_markduplicates/output_bam"
      - id: reference_fasta_path
        source: "#reference_fasta_path"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "markduplicates_readgroups"
    outputs:
      - id: output_sqlite

  - id: samtools_idxstats
    run: ../../tools/samtools_idxstats.cwl.yaml
    scatter: "#samtools_idxstats/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_buildbamindex/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "sorted_readgroup"
    outputs:
      - id: log
      - id: output_sqlite

  - id: samtools_flagstat
    run: ../../tools/samtools_flagstat.cwl.yaml
    scatter: "#samtools_flagstat/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_sortsam/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "sorted_readgroup"
    outputs:
      - id: log
      - id: output_sqlite

  - id: samtools_stats
    run: ../../tools/samtools_stats.cwl.yaml
    scatter: "#samtools_stats/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_sortsam/output_bam"
      - id: uuid
        source: "#uuid"
      - id: input_state
        default: "sorted_readgroup"
    outputs:
      - id: log
      - id: output_sqlite

  - id: picard_collectmultiplemetrics
    run: ../../tools/picard_collectmultiplemetrics.cwl.yaml
    scatter: "#picard_collectmultiplemetrics/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_sortsam/output_bam"
      - id: uuid
        source: "#uuid"
      - id: reference_fasta_path
        source: "#reference_fasta_path"
      - id: input_state
        default: "sorted_readgroup"
    outputs:
      - id: log
      - id: output_sqlite

  - id: merge_picard_collectmultiplemetrics_sqlite
    run: ../../tools/merge_sqlite.cwl.yaml
    inputs:
      - id: source_sqlite
        source: "#picard_collectmultiplemetrics/output_sqlite"
      - id: uuid
        source: "#uuid"
    outputs:
      - id: destination_sqlite
      - id: log

  - id: picard_collectoxogmetrics
    run: ../../tools/picard_collectoxogmetrics.cwl.yaml
    scatter: "#picard_collectoxogmetrics/bam_path"
    inputs:
      - id: bam_path
        source: "#picard_sortsam/output_bam"
      - id: db_snp_path
        source: "#db_snp_path"
      - id: input_state
        default: "sorted_readgroup"
      - id: reference_fasta_path
        source: "#reference_fasta_path"
      - id: uuid
        source: "#uuid"
    outputs:
      - id: log
      - id: output_sqlite
        
  - id: merge_all_sqlite
    run: ../../tools/merge_sqlite.cwl.yaml
    inputs:
      - id: source_sqlite
        source: ["#merge_picard_buildbamindex_sqlite/destination_sqlite", "#samtools_flagstat_sqlite/destination_sqlite", "#samtools_stats_sqlite/destination_sqlite", "#picard_collectmultiplemetrics_sqlite/destination_sqlite", "#picard_collectoxogmetrics_sqlite/destination_sqlite"]
      - id: uuid
        source: "#uuid"
    outputs:
      - id: destination_sqlite
      - id: log
