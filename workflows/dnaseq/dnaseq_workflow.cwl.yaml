#!/usr/bin/env cwl-runner

class: Workflow

inputs:
#  - id: "#bam_path"
#    type: File
  - id: "#fastq1_path" # temp for testing
    type: File
  - id: "#fastq2_path" # temp for testing
    type: File
  - id: "#readgroup_json_path" # temp for testing
    type: File
  - id: "#reference_fasta_path"
    type: File
  - id: "#thread_count"
    type: string
  - id: "#uuid"
    type: string
  - id: "#db_cred_s3url"
    type: ["null", string]
  - id: "#s3cfg_path"
    type: ["null", File]
    
outputs:
#  - id: "#output_json"
#    type:
#      type: array
#      items: File
#    source: "#bam_readgroup_to_json.output_json"

#  - id: "#output_fastq"
#    type:
#      type: array
#      items: File
#    source: "#bam_readgroup_to_json.output_fastq"

  - id: "#output_bam"
    type: File
    source: "#gatk_printreads.output_bam"

requirements:
  - class: ScatterFeatureRequirement
    
steps:
#  - id: "#biobambam2_bamtofastq"
#    run: {import: ../../tools/biobambam2_bamtofastq.cwl.yaml}
#    inputs:
#      - id: "#biobambam2_bamtofastq.bam_path"
#        source: "#bam_path"
#      - id: "#biobambam2_bamtofastq.uuid"
#        source: "#uuid"
#    outputs:
#      - id: "#biobambam2_bamtofastq.output_fastq"

  - id: "#bam_readgroup_to_json"
    run: {import: ../../tools/bam_readgroup_to_json.cwl.yaml}
    inputs:
      - id: "#bam_readgroup_to_json.bam_path"
        source: "#bam_path"
      - id: "#bam_readgroup_to_json.uuid"
        source: "#uuid"
    outputs:
      - id: "#bam_readgroup_to_json.output_json"

   - id: "#bwa_pe"
     run: {import: ../../tools/bwa_pe.cwl.yaml}
     #scatter: ["#bwa_pe.fastq1_path", "#bwa_pe.fastq2.path"]
     #scatterMethod: "dotproduct"
     inputs:
       - id: "#bwa_pe.fastq1_path"
         source: "#fastq1_path"
       - id: "#bwa_pe.fastq2_path"
         source: "#fastq2_path"
       - id: "#bwa_pe.reference_fasta_path"
         source: "#reference_fasta_path"
       - id: "#bwa_pe.readgroup_json_path"
         source: "#readgroup_json_path" #
       - id: "#bwa_pe.thread_count"
         source: "#thread_count"
       - id: "#bwa_pe.uuid"
         source: "#uuid"
     outputs:
       - id: "#bwa_pe.output_bam"

  # - id: "#picard_merge"
  #   run: {import: ../../tools/gatk_printreads.cwl.yaml}
  #   inputs:
  #     - id: "#picard_merge.bam_path"
  #       source: "#bwa_pe.output_bam"
  #     - id: "#picard_merge.uuid"
  #       source: "#uuid"
  #   outputs:
  #     - id: "#picard_merge.output_bam"

  # - id: "#cdis_reheader"
  #   run: {import: ../../tools/reheader.cwl.yaml}
  #   scatter: ["#gatk_printreads.bam_path", "#gatk_printreads.bqsr_grp_path"]
  #   scatterMethod: "dotproduct"
  #   inputs:
  #     - id: "#cdis_reheader.bam_path"
  #       source: "#picard_merge.output_bam"
  #     - id: "#cdis_reheader.uuid"
  #       source: "#uuid"
  #   outputs:
  #     - id: "#cdis_reheader.output_bam"

  # - id: "#picard_markduplicates"
  #   run: {import: ../../tools/picard_markduplicates.cwl.yaml}
  #   inputs:
  #     - id: "#gatk_printreads.bam_path"
  #       source: "#gatk_baserecalibrator.output_bam"
  #     - id: "#gatk_printreads.bqsr_grp_path"
  #       source: "#gatk_baserecalibrator.output_grp"
  #     - id: "#gatk_printreads.reference_fasta_path"
  #       source: "#reference_fasta_path"
  #     - id: "#gatk_printreads.thread_count"
  #       source: "#thread_count"
  #     - id: "#gatk_printreads.uuid"
  #       source: "#uuid"
  #     - id: "#gatk_printreads.db_cred_s3url"
  #       source: "#db_cred_s3url"
  #     - id: "gatk_printreads.s3cfg_path"
  #       source: "#s3cfg_path"
  #   outputs:
  #     - id: "#gatk_printreads.output_bam"
  #     - id: "#gatk_printreads.output_bai"
  #     - id: "#gatk_printreads.log"
